<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Show dataset</title>
  </head>
  <body>
    <div>
      <label for="file">File (.json)</label>
      <input name="file" id="file" type="file">
    </div>

    <div id="chart"></div>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      window.draw = null
      google.charts.load('current', {packages: ['corechart', 'line']})
      google.charts.setOnLoadCallback(draw => {
        window.draw = draw
      })

      document.getElementById('file').addEventListener('change', handleFileSelect, false);

      function handleFileSelect(evt) {
        var files = evt.target.files
        if (files.length < 1) throw new Error('please provide file')
        const file = files[0]
        var reader = new FileReader()

        reader.onload = handleFileRead

        reader.readAsText(file)
      }

      function handleFileRead(e) {
        let json = JSON.parse(e.target.result)
        json = json.sort((a, b) => new Date(a.time) - new Date(b.time))

        const options = {
          title: 'data',
          interpolateNulls: true,
          hAxis: {
            title: 'Time'
          },
          vAxis: {
            title: 'high',
            direction: 'r'
          },
          height: 300,
          width: 1200,
          legend: {position: 'none'}
        }
        drawOnChart(json, options)
        drawMedianDifferencing(json)
      }


      function drawOnChart (json, options) {
        const data = [['time', 'high']].concat(json.map(i => [i.time, i.high]))

        let data1 = google.visualization.arrayToDataTable(data, false)
        var chart = new google.visualization.LineChart(document.getElementById('chart'))
        chart.draw(data1, options)
      }

      function drawMedianDifferencing (data) {
        const highs = data.map(l => +l.high)
        const rreal = medianDifferencing(highs)
        const rrealIndexes = medianDifferencing(highs, {indexes: true})
        console.log('rreal', rreal)
        console.log('rrealIndexes', rrealIndexes)
      }








    function medianDifferencing (array, opts, callback) {
      let threshold = (opts && opts.threshold) || 3
      console.log('threshold', threshold)

      let arr = array.map((e, i) => Math.round(Math.abs(e - (array[i > 0 && ((i - 1) || 0)]))) + 1)
      let median = calcMedian(arr)

      let check = (e) => e / median > threshold

      let res = (opts && !!opts.indexes)
        ? arr.map((e, i) => check(e) && i).filter((e) => e !== false)
        : array.filter((e, i) => check(arr[i]))

      return (callback) ? callback(null, res) : res
    }

    function calcMedian (values) {
      if (values.length === 0) { return NaN }

      let arr = values.slice(0).sort((a, b) => a - b)
      let half = ~~(arr.length / 2)

      return (arr.length % 2) ? arr[half] : (arr[half - 1] + arr[half]) / 2.0
    }

    </script>
  </body>
</html>